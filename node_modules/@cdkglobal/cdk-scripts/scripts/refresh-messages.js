"use strict";

// Update translation files with new/removed messages

const chalk = require("chalk");
const fs = require("fs-extra");
const globSync = require("glob").sync;
const path = require("path");
const paths = require("../config/paths");

const messagesDir = paths.appLocales;

const defaultLocaleFile = path.join(messagesDir, "en.json");

console.log(
  "Loading default messages from '" + chalk.cyan(defaultLocaleFile) + "'..."
);

const loadMessages = filename => JSON.parse(fs.readFileSync(filename, "utf8"));

const defaultData = loadMessages(defaultLocaleFile);

// look for files matching src/i18n/xx[-yy].json
globSync(path.join(messagesDir, "??*(-??).json")).forEach(file => {
  if (!path.relative(file, defaultLocaleFile)) {
    // skip the default file to itself
    return;
  }
  console.log(
    "Rebuilding '" + chalk.cyan(file) + "'..."
  );

  const data = loadMessages(file);

  const rebuiltMessages = Object.getOwnPropertyNames(defaultData)
    .sort()
    .reduce((collection, id) => {
      if (data.hasOwnProperty(id)) {
        // has this message, keep as is
        collection[id] = data[id];
      } else {
        // missing, put the default message in there
        collection[id] = defaultData[id];
      }
      return collection;
    }, {});

  // Delete the old file
  fs.removeSync(file);

  // Write the rebuilt messages
  fs.writeFileSync(file, JSON.stringify(rebuiltMessages, null, 2));
});

console.log(chalk.green("Completed successfully.\n"));
