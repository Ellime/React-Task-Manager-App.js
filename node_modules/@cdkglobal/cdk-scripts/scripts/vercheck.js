'use strict';

var exec = require('child_process').exec;
var path = require('path');
var compareVersions = require('compare-versions');

var pkg = require(path.resolve(process.cwd(), 'package.json'));

function fail(msg) {
  console.error(msg);
  process.exit(1);
}

function execute(command, callback) {
  exec(command, function(error, stdout, stderr) {
    if (error) {
      fail(error);
    }
    callback(stdout);
  });
}

execute(`npm view ${pkg.name} version`, function(latest) {
  if (!latest) {
    fail('Unable to get the package version from npm');
  }
  latest = latest.trim();
  console.log('package version', `'${pkg.version}'`);
  console.log('npm version', `'${latest}'`);
  if (compareVersions(pkg.version, latest) !== 1) {
    fail(
      "Cannot publish over existing version. Update the 'version' field in package.json and try again."
    );
  }
  console.log('OK to publish!');
});
