# http

A decorator for native `fetch()` allowing you to make HTTP calls from the client. It adds the following:

* Any response codes not in 200-299 range are considered as errors
* Parsing of JSON responses based on Content-type header. Returned Promise resolves with an object for '_application/json_'.
* Any stored credentials are passed through in each the HTTP request for the current domain. This means that when the page and API share the credentials (which they generally do), the API calls don't need to re-authenticate.
* Query string can be passed in as an object hash.
* You can provide custom error messages for HTTP errors.
* Adds `correlationId` header into each request.
* Allows routing.

## Installation

```bash
npm install --save @cdkglobal/react-core-http
```

```js
import http from "@cdkglobal/react-core-http";
```

```js
import { fnName, ... } from "@cdkglobal/react-core-http";
```

## Named exports

* `get({url, headers})` Perform a HTTP GET.
* `put({url, headers, data})` Perform a HTTP PUT. Data is expected to be a Javascript object.
* `post({url, headers, data})` Perform a HTTP POST. Data is expected to be a Javascript object.
* `patch({url, headers, data})` Perform a HTTP PATCH. Data is expected to be a Javascript object.
* `delete({url, headers})` Perform a HTTP DELETE.
* `registerStatusCodes(map)` A map of codes -> custom error strings.
* `clearStatusCodes()` Clears any mapped status codes.
* `registerRoutes(map)` Register a route mapping hash.
* `clearRoutes()` Clears any mapped routes.
* `setDefaultOptions(options)` Set default options for the fetch module on all the HTTP verbs.
* `clearDefaultOptions()` Clear default options for the fetch module on all the HTTP verbs.

### url

In each mathod, the URL can be specified either as a plain string or an object.

* `String` The string is used as-is to make the request.
* `Object` The object is expected to have the following properties:
  * `baseUrl` The URL as a string without a query string.
  * `query` An object hash of name-value pairs which will be appended to the baseUrl as a query string.

### Error object

* `message` Error message. In preference the payload object is inspected for existance of `message` (or `msg`) property. Othwerwise a generic status description is returned.
* `response` If a response was received then this contains the raw response object from native `fetch()`.
* `payload` Response payload. If the response was `application/json` then this is an object. Othwerwise a string.

```js static
import { get, post } from '@cdkglobal/react-core/http';

// Basic GET
try {
  await response = get({
    url: '/api/dogs'
  });
  // process a 200 response
} catch(error) {
  // process error
}

// Complex URL. Final URL in this instance will be /api/dogs?limit=10&offset=20
get({
  url: {
    baseUrl: '/api/dogs',
    query: {
      limit: 10,
      offset: 20,
    }
  }
})

// POST with payload
post({
  url: '/api/dogs',
  data: {
    name: 'My new dog',
    color: 'Brown',
  }
})
```

### Custom headers

```js static
import { get } from '@cdkglobal/react-core-http';

// Basic GET
get({
  url: '/api/dogs',
  headers: {
    Authorization: 'Bearer token-id',
  }
});
```

### Custom status errors

You can provide your own messages for HTTP error codes.

```js static
import { registerStatusCodes } from "@cdkglobal/react-core-http";

registerStatusCodes({
  401: "Please login.",
  409: "Someone else has this locked."
});
```

### Routing

The following sample will map:

* `/api/survey/v1/surveys` to `/api/ari-gp-survey/v1/surveys`
* `/api/org/v1/users/self` to `/api/ari-gp-organization/v1/users/self`

```js static
import { registerRoutes } from "@cdkglobal/react-core/http";

registerRoutes({
  "/api/org/": "/api/ari-gp-organization/",
  "/api/survey/": "/api/ari-gp-survey/"
});
```
