# Redux API middleware.

This middleware allows you to dispatch actions which make HTTP API calls to the server.
You can also add a custom error handler allowing you to perform specific actions such as
redirecting the user to another page.

## Installation

```bash
npm install --save @cdkglobal/react-core-reduxapi
```

```js
import reduxapi from "@cdkglobal/react-core-reduxapi";
```

Or

```js
import { fnName, ... } from "@cdkglobal/react-core-reduxapi";
```

## Setup

```js
import { apiMiddleware } from "@cdkglobal/react-core-reduxapi";

const store = createStore(reducer, state, applyMiddleware(apiMiddleware));
```

## `CALL_API` object

The middleware inspects the existance of `CALL_API` property in the action and if present it handles it. This property is expected to contain an object with the following properties supported:

* `url` The API URL. Supports the same spec as `@cdkglobal/react-core/http`.
* `method` HTTP method. One of GET, POST, PUT, PATCH or DELETE.
* `data` Request payload for POST, PUT and PATCH. Expected to be a Javascript object.
* `headers` Optional request headers. Expected to be a Javascript object.
* `types` An array which is expected contain 3 action types in this order [`REQUEST`, `RECEIVE`, `ERROR`].

## Basic example

```js
import { combineReducers } from "redux";
import { CALL_API } from "@cdkglobal/react-core-reduxapi";

const types = {
  DOG_GET_REQUEST: "DOG_GET_REQUEST",
  DOG_GET_RECEIVE: "DOG_GET_RECEIVE",
  DOG_GET_ERROR: "DOG_GET_ERROR"
};

const dog = (state = null, action) => {
  switch (action.type) {
    case types.DOG_GET_RECEIVE:
      return action.response;
    default:
      return state;
  }
};

const loading = (state = false, action) => {
  switch (action.type) {
    case types.DOG_GET_REQUEST:
      return true;
    case types.DOG_GET_RECEIVE:
    case types.DOG_GET_ERROR:
      return false;
    default:
      return state;
  }
};

export default combineReducers({
  dog,
  loading
});

const getDogByID = id => ({
  url: `/api/dogs/${id}`,
  method: "GET",
  headers: {
    Authorization: "Bearer <token_id>"
  }
});

export const actions = {
  fetch: id => {
    return {
      [CALL_API]: {
        ...getDogByID(id),
        types: [
          types.DOG_GET_REQUEST,
          types.DOG_GET_RECEIVE,
          types.DOG_GET_ERROR
        ]
      }
    };
  }
};
```

## Action types

* `REQUEST` This action is dispatched before the request is made. Usefull for turning on a loading indicator.
* `RECEIVE` This action is dispatched when a 200(-299) response is received from the server. Action has the following properties:
  * `response` The response from the server. If the response is `application/json` Then this will be a Javascript object reprenting the JSON.
* `ERROR` This action is dispatched when a **non** 200(-299) response is received from the server. Action has the following properties:
  * `apierror` The error object. This is the same as `@cdkglobal/react-core/http` error object.

Action type can be either a string, object or a function:

* `string` An action is dispatched with `type` property set to the provided string.
* `object` An action is dispatched with all properties copied from the provided object. Expected to contain a `type` property.
* `function` This function is expected to return an action object which is then dispatched as is. Following parameters are provided based on the action type:
  * `REQUEST` () => No parameters supplied
  * `RECEIVE` (`response`) => Same as `response` in the the `RECEIVE` action.
  * `ERROR` (`error`) => Same as `apierror` in the the `ERROR` action.

### Object action type example

```js
const param = (state = null, action) => {
  switch (action.type) {
    case types.DOG_GET_REQUEST:
      return action.id;
    default:
      return state;
  }
};

const actions = {
  fetch: id => {
    return {
      [CALL_API]: {
        ...getDogByID(id),
        types: [
          { type: types.DOG_GET_REQUEST, id },
          types.DOG_GET_RECEIVE,
          types.DOG_GET_ERROR
        ]
      }
    };
  }
};
```

### Function action type example

```js
const actions = {
  fetch: id => {
    return {
      [CALL_API]: {
        ...getDogByID(id),
        types: [
          types.DOG_GET_REQUEST,
          types.DOG_GET_RECEIVE,
          error =>
            // Turn 404 into a success
            error.response && error.response.status === 404
              ? { type: types.DOG_GET_RECEIVE, response: null }
              : { type: types.DOG_GET_ERROR, error }
        ]
      }
    };
  }
};
```

## Custom error handling

If you want to handle errors yourself, use the `createApiMiddleWare` function and pass in a
config object that contains your custom `onError` handler.

The `onError` function is passed an object with the following properties:

* `dispatch` The redux dispatch function. Use this to dispatch your own actions.
* `getState` Call this to access to redux store.
* `error` The error exception object. The HTTP fetch status can be accessed using `error.response`.
* `dispatchError` Call this for default error handling.

For example:

```js
import reduxapi from "@cdkglobal/react-core-reduxapi";

const onError = ({ dispatch, getState, error, dispatchError }) => {
  // Refresh the page on a 401 error
  if (error.response.status === 401) {
    window.reload();
  } else {
    // Call original error handler
    return dispatchError();
  }
};

const store = createStore(
  reducer,
  state,
  applyMiddleware(reduxapi.createApiMiddleware({ onError }))
);
```
